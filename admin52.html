<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админка заявок | АВН</title>
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/country.css" />
  <link rel="icon" href="logo.svg" type="image/svg+xml" />
  <style>
    * {
      font-family: 'Futura', sans-serif;
    }

    /* Твой стиль для админки */
    .application {
      background-color: #1a1a1a;
      border-radius: 16px;
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
      margin-bottom: 40px;
      padding: 30px;
      color: #fff;
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .btns {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    button {
      cursor: pointer;
      border-radius: 20px;
      border: none;
      padding: 12px 28px;
      font-size: 18px;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button.approve {
      background-color: #28a745;
      color: white;
    }
    button.approve:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    button.reject {
      background-color: #dc3545;
      color: white;
    }
    button:hover:not(:disabled) {
      filter: brightness(1.15);
    }

    /* Форма входа */
    #auth-wrapper {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
      color: #eee;
      padding: 20px;
    }
    #auth-wrapper input[type="email"],
    #auth-wrapper input[type="password"] {
      font-size: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      margin-top: 15px;
      width: 280px;
      background: #222;
      color: #eee;
      outline: none;
      box-sizing: border-box;
    }
    #auth-wrapper button {
      margin-top: 20px;
      padding: 12px 32px;
      font-size: 20px;
      border-radius: 8px;
      border: none;
      background-color: #28a745;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #auth-wrapper button:hover {
      background-color: #218838;
    }
    #auth-error {
      margin-top: 15px;
      color: #dc3545;
      font-weight: 700;
      min-height: 24px;
    }

    /* Скрываем админку пока не залогинен */
    #admin-content {
      display: none;
      max-width: 1400px;
      margin: 80px auto;
      padding: 0 20px;
      color: white;
    }
    #logout-btn {
      margin-bottom: 20px;
      padding: 10px 20px;
      background-color: #dc3545;
      border-radius: 20px;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>

<header>
  <div class="container">
    <nav id="navigation">
      <img src="logo.svg" alt="Логотип сайта" class="logo" width="65px" />
      <a class="nav-toggle"><span></span><span></span><span></span></a>
      <div class="menu-links menu">
        <a href="index.html">Главная</a>
        <a href="map.html">Карта</a>
        <a href="countries.html">Страны</a>
        <a href="reg.html">Вступить</a>
        <a href="time.html">Время</a>
      </div>
      <div class="vk-link">
        <a href="https://vk.com/avncommunity"><img src="images/vk1.svg" alt="VK" class="vk-logo vk-small" width="50px" /></a>
      </div>
    </nav>
  </div>
</header>

<!-- Форма входа -->
<div id="auth-wrapper">
  <h1>Вход администратора</h1>
  <input type="email" id="email-input" placeholder="Email" />
  <input type="password" id="password-input" placeholder="Пароль" />
  <button id="login-btn">Войти</button>
  <div id="auth-error"></div>
</div>

<!-- Админка -->
<div id="admin-content">
  <button id="logout-btn">Выйти</button>
  <h1>Администрация</h1>
  <div id="tabs">
    <button id="tab-pending" class="tab active">Ждут рассмотрения</button>
    <button id="tab-approved" class="tab">Принятые</button>
  </div>
  <div id="applications-list">
    <p style="color:#bbb;">Загрузка заявок...</p>
  </div>
</div>

<footer>
  <div class="footer-logo"><img src="logo.svg" alt="Логотип проекта" /></div>
  <div class="footer-links">
    <p>❗Проект не имеет никакой реальной политической силы и является выдумкой.</p>
    <p>❗Мы не несём ответственности за действия вне сообщества ВК и сайта.</p>
  </div>
  <div class="footer-socials">
    <a href="https://vk.com/avncommunity"><img src="images/vk1.svg" alt="VK" /></a>
  </div>
  <div class="footer-copy">
    <p>© 2025 Евгений Чертин. Все права защищены.</p>
  </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getFirestore, collection, getDocs, updateDoc, deleteDoc, doc, query, orderBy
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";


  const firebaseConfig = {
    apiKey: "AIzaSyD1mSa0TpadaUqX5QxNoHaCJWWuJ8sXeLM",
    authDomain: "vgovernments-6c294.firebaseapp.com",
    projectId: "vgovernments-6c294",
    storageBucket: "vgovernments-6c294.appspot.com",
    messagingSenderId: "795317676699",
    appId: "1:795317676699:web:af8649e04af6216d14743e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Элементы
  const authWrapper = document.getElementById("auth-wrapper");
  const adminContent = document.getElementById("admin-content");
  const emailInput = document.getElementById("email-input");
  const passwordInput = document.getElementById("password-input");
  const loginBtn = document.getElementById("login-btn");
  const authError = document.getElementById("auth-error");
  const applicationsList = document.getElementById("applications-list");
  const logoutBtn = document.getElementById("logout-btn");

  let currentTab = "pending";

  // Отрисовка заявки
  function createApplicationCard(id, data) {
    const appDiv = document.createElement("div");
    appDiv.className = "application";

    appDiv.innerHTML = `
      <div class="form-grid">
        <div class="left-column">
          <div class="upload-wrapper">
            <p>${data.unitary || "—"}</p>
    
            <label class="upload-label">Флаг</label>
            <div class="flag-field">
              <img src="${data.flagUrl || 'images/default-flag.jpg'}" alt="Флаг страны" />
            </div>
          </div>
          <p><strong>Форма правления:</strong> ${data.ruleForm || "—"}</p>
          <p><strong>Религия:</strong> ${data.religion || "—"}</p>
          <p><strong>Население:</strong> ${data.population || "—"}</p>
          <p><strong>Государственное устройство:</strong> ${data.recognition || "—"}</p>
        </div>
        <div class="right-column">
          <label>Описание</label>
          <p style="white-space: pre-wrap;">${data.description || "Нет описания."}</p>
          <div class="photo-pair" style="margin-top: 20px;">
            <div class="centerphoto">
              <div class="upload-wrapper">
                <label class="upload-label">Правитель</label>
                <div class="photo-field">
                  <img src="${data.rulerPhotoUrl || 'images/default-avatar.jpg'}" alt="Фото правителя" />
                </div>
                <div class="phototext">
                  <p>${data.rulerName || "—"}</p>
                </div>
              </div>
            </div>
            <div class="centerphoto">
              <div class="upload-wrapper">
                <label class="upload-label">Валюта</label>
                <div class="valuta-field">
                  <img src="${data.currencyPhotoUrl || 'images/default-currency.jpg'}" alt="Изображение валюты" />
                </div>
                <div class="valuta-text">
                  <p>${data.currencyName || "—"}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="app-header" style="margin-top: 30px; justify-content: flex-start;">
        <div><strong>Статус:</strong> <span class="status">${data.status}</span></div>
        <div class="btns" style="margin-left: auto;">
          <button class="approve" ${data.status === "approved" ? "disabled" : ""}>Принять</button>
          <button class="reject">Отклонить</button>
        </div>
      </div>
    `;

    const approveBtn = appDiv.querySelector("button.approve");
    const rejectBtn = appDiv.querySelector("button.reject");
    const statusSpan = appDiv.querySelector(".status");

    approveBtn.addEventListener("click", async () => {
      try {
        await updateDoc(doc(db, "applications", id), { status: "approved" });
        statusSpan.textContent = "approved";
        approveBtn.disabled = true;
        alert("Заявка принята");
      } catch {
        alert("Ошибка при обновлении статуса");
      }
    });

    rejectBtn.addEventListener("click", async () => {
      if (!confirm("Вы действительно хотите отклонить и удалить заявку?")) return;
      try {
        await deleteDoc(doc(db, "applications", id));
        appDiv.remove();
        alert("Заявка отклонена и удалена");
      } catch {
        alert("Ошибка при удалении заявки");
      }
    });

    return appDiv;
  }

  // Загрузка заявок с фильтром по вкладке
  async function loadApplications() {
    applicationsList.innerHTML = '<p style="color:#bbb;">Загрузка заявок...</p>';
    try {
      const q = query(collection(db, "applications"), orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      applicationsList.innerHTML = "";

      let found = false;
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.status === currentTab) {
          const appCard = createApplicationCard(docSnap.id, data);
          applicationsList.appendChild(appCard);
          found = true;
        }
      });

      if (!found) {
        applicationsList.innerHTML = "<p>Заявок нет</p>";
      }
    } catch {
      applicationsList.innerHTML = "<p>Ошибка загрузки заявок</p>";
    }
  }

  // Переключение вкладок
  document.getElementById("tab-pending").addEventListener("click", () => {
    currentTab = "pending";
    document.getElementById("tab-pending").classList.add("active");
    document.getElementById("tab-approved").classList.remove("active");
    loadApplications();
  });

  document.getElementById("tab-approved").addEventListener("click", () => {
    currentTab = "approved";
    document.getElementById("tab-approved").classList.add("active");
    document.getElementById("tab-pending").classList.remove("active");
    loadApplications();
  });

  // Вход по email/password
  loginBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    authError.textContent = "";

    if (!email || !password) {
      authError.textContent = "Введите email и пароль";
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      // При успешном входе onAuthStateChanged переключит интерфейс
    } catch (error) {
      authError.textContent = "Ошибка входа: " + error.message;
    }
  });

  // Вход по Enter в полях
  [emailInput, passwordInput].forEach(el => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loginBtn.click();
    });
  });

  // Выход
  logoutBtn.addEventListener("click", () => {
    signOut(auth);
  });

  // Автоматический контроль состояния авторизации
  onAuthStateChanged(auth, user => {
    if (user) {
      authWrapper.style.display = "none";
      adminContent.style.display = "block";
      loadApplications();
    } else {
      authWrapper.style.display = "flex";
      adminContent.style.display = "none";
      emailInput.value = "";
      passwordInput.value = "";
      authError.textContent = "";
    }
  });

</script>

</body>
</html>
