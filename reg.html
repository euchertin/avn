<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Регистрация</title>
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/reg.css" />
  
</head>

<body>
  <div class="static-noise"></div>
  <header>
    <div class="container">
      <nav id="navigation">
        <img src="logo.svg" alt="Логотип сайта" class="logo" width="65" />
        <a aria-label="mobile menu" class="nav-toggle">
          <span></span><span></span><span></span>
        </a>
        <div class="menu-links menu">
          <a href="index.html">Главная</a>
          <a href="map.html">Карта</a>
          <a href="countries.html">Страны</a>
          <a href="reg.html">Вступить</a>
          <a href="time.html">Время</a>
        </div>
        <div class="vk-link">
          <a href="https://vk.com/vgovernments">
            <img src="images/vk1.svg" alt="VK" class="vk-logo vk-small" width="50" />
          </a>
        </div>
      </nav>
    </div>
  </header>

  <div class="form-wrapper">
    <h2>Подача заявки</h2>
    <form id="application-form" novalidate>
      <div class="form-grid">
        <div class="left-column">
          <div class="upload-wrapper">
            <label class="upload-label" for="flag-input">Загрузить флаг</label>
            <div class="flag-field" tabindex="0" role="button" aria-label="Выбрать флаг">
              <span class="upload-text">Нажмите, чтобы выбрать флаг</span>
              <input
                type="file"
                accept="image/*"
                id="flag-input"
                name="flag"
                class="upload-input"
                style="display:none"
                onchange="previewImage(this, 'flag-field')"
              />
            </div>
          </div>

          <input
            type="text"
            id="unitary"
            name="unitary"
            placeholder="Название страны"
            required
          />
          <input
            type="text"
            id="ruleForm"
            name="ruleForm"
            placeholder="Форма правления"
            required
          />
          <input
            type="text"
            id="religion"
            name="religion"
            placeholder="Государственная религия"
          />
          <input
            type="text"
            id="population"
            name="population"
            placeholder="Население"
            required
          />
          <input
            type="text"
            id="recognition"
            name="recognition"
            placeholder="Признание (частично признанное и т.д.)"
          />
        </div>

        <div class="right-column">
          <label for="description">Описание</label>
          <textarea
            id="description"
            name="description"
            placeholder="Введите описание..."
            required
          ></textarea>

          <div class="photo-pair">
            <div class="centerphoto">
              <div class="upload-wrapper">
                <label class="upload-label" for="photo-input">Правитель</label>
                <div class="photo-field" tabindex="0" role="button" aria-label="Выбрать фото правителя">
                  <span class="upload-text">Нажмите, чтобы выбрать фото</span>
                  <input
                    type="file"
                    accept="image/*"
                    id="photo-input"
                    name="photo"
                    class="upload-input"
                    style="display:none"
                    onchange="previewImage(this, 'photo-field')"
                  />
                </div>
                <div class="phototext">
                  <input
                    type="text"
                    id="rulerName"
                    name="rulerName"
                    placeholder="Как зовут правителя?"
                    required
                  />
                </div>
              </div>
            </div>

            <div class="centerphoto">
              <div class="upload-wrapper">
                <label class="upload-label" for="valuta-input">Валюта</label>
                <div class="valuta-field" tabindex="0" role="button" aria-label="Выбрать фото валюты">
                  <span class="upload-text">Нажмите, чтобы выбрать фото</span>
                  <input
                    type="file"
                    accept="image/*"
                    id="valuta-input"
                    name="valuta"
                    class="upload-input"
                    style="display:none"
                    onchange="previewImage(this, 'valuta-field')"
                  />
                </div>
                <div class="valuta-text">
                  <input
                    type="text"
                    id="currencyName"
                    name="currencyName"
                    placeholder="Название валюты?"
                    required
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn">Отправить</button>
    </form>
  </div>

  <div class="popup-overlay" id="popup" style="display:none;">
    <div class="popup-content">
      <p>Введите ваш VK ID:</p>
      <input
        type="text"
        id="vk-id-input"
        placeholder="например, 12345678 или idusername"
        required
      />
      <div class="popup-actions">
        <button type="button" class="popup-btn" id="popup-ok-btn">OK</button>
      </div>
      <p id="vk-error" class="error-text"></p>
    </div>
  </div>

  <footer>
    <div class="footer-logo">
      <img src="logo.svg" alt="Логотип проекта" />
    </div>
    <div class="footer-links">
      <p>❗Проект не имеет никакой реальной политической силы и не ставит своей целью что-либо из политики. Он подчистую является выдумкой.</p>
      <p>❗Мы предоставляем платформу внутри ВК и не несём ответственность за действия вне неё.</p>
    </div>
    <div class="footer-socials">
      <a href="https://vk.com/vgovernments"><img src="images/vk1.svg" alt="VK" /></a>
    </div>
    <div class="footer-copy">
      <p>© 2025 Евгений Чертин. Все права защищены.</p>
    </div>
  </footer>

 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const IMGBB_API_KEY = "8991694a4eefb36967a0130b1383d524";

    const firebaseConfig = {
      apiKey: "AIzaSyD1mSa0TpadaUqX5QxNoHaCJWWuJ8sXeLM",
      authDomain: "vgovernments-6c294.firebaseapp.com",
      projectId: "vgovernments-6c294",
      storageBucket: "vgovernments-6c294.appspot.com",
      messagingSenderId: "795317676699",
      appId: "1:795317676699:web:af8649e04af6216d14743e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Глобальная функция для превью изображений
    window.previewImage = function(input, fieldClass) {
      const file = input.files[0];
      if (!file) return;

      const container = document.querySelector(`.${fieldClass}`);
      const uploadText = container.querySelector('.upload-text');
      
      if (uploadText) {
        uploadText.style.display = 'none';
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const oldImg = container.querySelector('img');
        if (oldImg) oldImg.remove();
        
        const img = document.createElement('img');
        img.src = e.target.result;
        container.appendChild(img);
      };
      reader.readAsDataURL(file);
    };

    async function uploadToImgBB(file) {
      const formData = new FormData();
      formData.append('image', file);
      
      try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error?.message || 'Ошибка загрузки на imgBB');
        }
        
        return data.data.url;
      } catch (error) {
        console.error('Ошибка загрузки:', error);
        throw new Error('Не удалось загрузить изображение. Попробуйте ещё раз.');
      }
    }

    function validateForm(form) {
      if (!form.checkValidity()) {
        form.reportValidity();
        return false;
      }
      
      // Дополнительные проверки
      if (!document.getElementById('flag-input').files[0]) {
        alert('Пожалуйста, загрузите флаг');
        return false;
      }
      
      if (!document.getElementById('photo-input').files[0]) {
        alert('Пожалуйста, загрузите фото правителя');
        return false;
      }
      
      if (!document.getElementById('valuta-input').files[0]) {
        alert('Пожалуйста, загрузите изображение валюты');
        return false;
      }
      
      return true;
    }

    let currentVkID = localStorage.getItem("vkID") || "";

    async function submitApplication(event) {
      event.preventDefault();
      const form = event.target;

      if (!validateForm(form)) return;

      if (!currentVkID) {
        openPopup();
        return;
      }

      const submitBtn = form.querySelector(".submit-btn");
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Отправка...";

      try {
        const flagFile = form.flag.files[0];
        const photoFile = form.photo.files[0];
        const valutaFile = form.valuta.files[0];

        // Загружаем изображения последовательно для избежания ошибок
        const flagUrl = await uploadToImgBB(flagFile);
        const photoUrl = await uploadToImgBB(photoFile);
        const valutaUrl = await uploadToImgBB(valutaFile);

        await addDoc(collection(db, "applications"), {
          unitary: form.unitary.value.trim(),
          ruleForm: form.ruleForm.value.trim(),
          religion: form.religion.value.trim(),
          population: form.population.value.trim(),
          recognition: form.recognition.value.trim(),
          description: form.description.value.trim(),
          rulerName: form.rulerName.value.trim(),
          currencyName: form.currencyName.value.trim(),
          flagUrl,
          photoUrl,
          valutaUrl,
          vkID: currentVkID,
          timestamp: new Date()
        });

        alert("Заявка отправлена успешно!");
        form.reset();
        
        // Очищаем превью изображений
        document.querySelectorAll('.flag-field, .photo-field, .valuta-field').forEach(field => {
          const img = field.querySelector('img');
          const text = field.querySelector('.upload-text');
          if (img) img.remove();
          if (text) text.style.display = '';
        });
      } catch (error) {
        console.error("Ошибка при отправке:", error);
        alert("Ошибка: " + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
    }

    // Остальной код (обработчики событий, popup) остаётся без изменений
    const form = document.getElementById("application-form");
    if (form) {
      form.addEventListener("submit", submitApplication);
    }

    // Popup для ввода VK ID
    const popup = document.getElementById("popup");
    const vkInput = document.getElementById("vk-id-input");
    const vkError = document.getElementById("vk-error");
    const popupOkBtn = document.getElementById("popup-ok-btn");

    function openPopup() {
      if (popup) {
        vkInput.value = currentVkID;
        vkError.textContent = "";
        popup.style.display = "flex";
        vkInput.focus();
      }
    }

    function closePopup() {
      if (popup) popup.style.display = "none";
    }

    if (popupOkBtn) {
      popupOkBtn.addEventListener("click", () => {
        const val = vkInput.value.trim();
        if (!val) {
          vkError.textContent = "Пожалуйста, введите ваш VK ID";
          vkInput.focus();
          return;
        }
        
        currentVkID = val;
        localStorage.setItem("vkID", val);
        closePopup();
      });
    }

    // Проверка наличия VK ID при загрузке страницы
    window.addEventListener("load", () => {
      if (!currentVkID) {
        openPopup();
      }
    });

    // Привязка кликов к видимым дивам для файлов
    document.querySelectorAll(".flag-field").forEach(div => {
      div.addEventListener("click", () => {
        document.getElementById("flag-input").click();
      });
      div.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          document.getElementById("flag-input").click();
        }
      });
    });

    document.querySelectorAll(".photo-field").forEach(div => {
      div.addEventListener("click", () => {
        document.getElementById("photo-input").click();
      });
      div.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          document.getElementById("photo-input").click();
        }
      });
    });

    document.querySelectorAll(".valuta-field").forEach(div => {
      div.addEventListener("click", () => {
        document.getElementById("valuta-input").click();
      });
      div.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          document.getElementById("valuta-input").click();
        }
      });
    });
  </script>
</body>
</html>