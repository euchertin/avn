<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Регистрация</title>
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/reg.css" />
</head>

<body>
  <div class="static-noise"></div>
  <header>
    <div class="container">
      <nav id="navigation">
        <img src="logo.svg" alt="Логотип сайта" class="logo" width="65" />
        <a aria-label="mobile menu" class="nav-toggle">
          <span></span><span></span><span></span>
        </a>
        <div class="menu-links menu">
          <a href="index.html">Главная</a>
          <a href="map.html">Карта</a>
          <a href="countries.html">Страны</a>
          <a href="reg.html">Вступить</a>
          <a href="time.html">Время</a>
        </div>
        <div class="vk-link">
          <a href="https://vk.com/vgovernments">
            <img src="images/vk1.svg" alt="VK" class="vk-logo vk-small" width="50" />
          </a>
        </div>
      </nav>
    </div>
  </header>

  <div class="form-wrapper">
    <h2>Подача заявки</h2>
    <div class="form-grid">
      <div class="left-column">
        <div class="upload-wrapper">
          <label class="upload-label" for="flag-input">Загрузить флаг</label>
          <div class="flag-field" onclick="document.getElementById('flag-input').click()">
            <span class="upload-text">Нажмите, чтобы выбрать флаг</span>
            <input
              type="file"
              accept="image/*"
              id="flag-input"
              class="upload-input"
              onchange="previewImage(event, 'flag-field')"
            />
          </div>
        </div>

        <input type="text" placeholder="Унитарное/федеративное" required />
        <input type="text" placeholder="Форма правления" required />
        <input type="text" placeholder="Государственная религия" />
        <input type="text" placeholder="Население" required />
        <input type="text" placeholder="Признание (частично признанное и т.д.)" />
      </div>

      <div class="right-column">
        <label for="description">Описание</label>
        <textarea id="description" placeholder="Введите описание..." required></textarea>
       
        <div class="photo-pair">
          <div class="centerphoto">
            <div class="upload-wrapper">
              <label class="upload-label" for="photo-input">Правитель</label>
              <div class="photo-field" onclick="document.getElementById('photo-input').click()">
                <span class="upload-text">Нажмите, чтобы выбрать фото</span>
                <input
                  type="file"
                  accept="image/*"
                  id="photo-input"
                  class="upload-input"
                  onchange="previewImage(event, 'photo-field')"
                />
              </div>
              <div class="phototext">
                <input type="text" placeholder="Как зовут правителя?" />
              </div>
            </div>
          </div>

          <div class="centerphoto">
            <div class="upload-wrapper">
              <label class="upload-label" for="valuta-input">Валюта</label>
              <div class="valuta-field" onclick="document.getElementById('valuta-input').click()">
                <span class="upload-text">Нажмите, чтобы выбрать фото</span>
                <input
                  type="file"
                  accept="image/*"
                  id="valuta-input"
                  class="upload-input"
                  onchange="previewImage(event, 'valuta-field')"
                />
              </div>
              <div class="valuta-text">
                <input type="text" placeholder="Название валюты?" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <button type="button" class="submit-btn">Отправить</button>
  </div>

  <div class="popup-overlay" id="popup">
    <div class="popup-content">
      <p>Введите ваш VK ID:</p>
      <input type="text" id="vk-id-input" placeholder="например, 12345678 или idusername" required />
      <div class="popup-actions">
        <button type="button" class="popup-btn" onclick="submitVK()">OK</button>
      </div>
      <p id="vk-error" class="error-text"></p>
    </div>
  </div>

  <footer>
    <div class="footer-logo">
      <img src="logo.svg" alt="Логотип проекта" />
    </div>
    <div class="footer-links">
      <p>❗Проект не имеет никакой реальной политической силы и не ставит своей целью что-либо из политики. Он подчистую является выдумкой.</p>
      <p>❗Мы предоставляем платформу внутри ВК и не несём ответственность за действия вне неё.</p>
    </div>
    <div class="footer-socials">
      <a href="https://vk.com/vgovernments"><img src="images/vk1.svg" alt="VK" /></a>
    </div>
    <div class="footer-copy">
      <p>© 2025 Евгений Чертин. Все права защищены.</p>
    </div>
  </footer>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const IMGUR_CLIENT_ID = "bcc6163b116707d";
  const firebaseConfig = {
    apiKey: "AIzaSyD1mSa0TpadaUqX5QxNoHaCJWWuJ8sXeLM",
    authDomain: "vgovernments-6c294.firebaseapp.com",
    projectId: "vgovernments-6c294",
    storageBucket: "vgovernments-6c294.appspot.com",
    messagingSenderId: "795317676699",
    appId: "1:795317676699:web:af8649e04af6216d14743e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function uploadToImgur(file) {
    const formData = new FormData();
    formData.append("image", file);

    const response = await fetch("https://api.imgur.com/3/image", {
      method: "POST",
      headers: {
        Authorization: "Client-ID " + IMGUR_CLIENT_ID,
      },
      body: formData,
    });

    const data = await response.json();
    if (!data.success) throw new Error("Ошибка загрузки на Imgur");
    return data.data.link;
  }

  function validateForm() {
    const requiredInputs = document.querySelectorAll('.left-column input[required]');
    for (let input of requiredInputs) {
      if (!input.value.trim()) {
        alert('Пожалуйста, заполните все обязательные поля слева.');
        return false;
      }
    }
    const description = document.getElementById("description");
    if (!description.value.trim()) {
      alert('Пожалуйста, заполните описание.');
      return false;
    }
    return true;
  }

  async function submitApplication() {
  const unitary = document.querySelector('input[placeholder="Унитарное/федеративное"]').value;
  const ruleForm = document.querySelector('input[placeholder="Форма правления"]').value;
  const religion = document.querySelector('input[placeholder="Государственная религия"]').value;
  const population = document.querySelector('input[placeholder="Население"]').value;
  const recognition = document.querySelector('input[placeholder="Признание (частично признанное и т.д.)"]').value;
  const description = document.getElementById("description").value;
  const rulerName = document.querySelector(".phototext input").value;
  const currencyName = document.querySelector(".valuta-text input").value;
  const vkId = document.getElementById("vk-id-input").value;
  const flagUrl = document.querySelector(".flag-field").dataset.imgur || "";
  const rulerPhotoUrl = document.querySelector(".photo-field").dataset.imgur || "";
  const currencyPhotoUrl = document.querySelector(".valuta-field").dataset.imgur || "";

  try {
    // Проверка текстов
    const allTextChecks = await Promise.all([
      checkTextWithSightengine(description),
      checkTextWithSightengine(rulerName),
      checkTextWithSightengine(currencyName),
    ]);

    if (allTextChecks.includes(false)) {
      alert("В тексте содержится недопустимый контент (мат или 18+).");
      return;
    }

    // Проверка изображений
    const allImageChecks = await Promise.all([
      flagUrl ? checkImageWithSightengine(flagUrl) : true,
      rulerPhotoUrl ? checkImageWithSightengine(rulerPhotoUrl) : true,
      currencyPhotoUrl ? checkImageWithSightengine(currencyPhotoUrl) : true,
    ]);

    if (allImageChecks.includes(false)) {
      alert("Одно из изображений содержит нежелательный контент (оружие, наркотики, NSFW).");
      return;
    }

    const data = {
      unitary,
      ruleForm,
      religion,
      population,
      recognition,
      description,
      flagUrl,
      rulerPhotoUrl,
      rulerName,
      currencyPhotoUrl,
      currencyName,
      vkId
    };

    await addDoc(collection(db, "applications"), data);
    alert("Заявка успешно отправлена!");
  } catch (error) {
    console.error("Ошибка при отправке:", error);
    alert("Ошибка при отправке заявки.");
  }
}


  window.previewImage = async function (event, fieldClass) {
    const file = event.target.files[0];
    if (!file) return;

    const container = document.querySelector(`.${fieldClass}`);
    container.innerHTML = '<span class="upload-text">Загрузка...</span>';

    try {
      const link = await uploadToImgur(file);
      container.innerHTML = `<img src="${link}" alt="Изображение" />`;
      container.dataset.imgur = link;
    } catch (err) {
      container.innerHTML = '<span class="upload-text">Ошибка загрузки</span>';
      console.error(err);
    }
  };

  window.submitVK = async function () {
    const vkInput = document.getElementById("vk-id-input");
    const vkId = vkInput.value.trim();
    const errorText = document.getElementById("vk-error");
    const popup = document.getElementById("popup");

    if (!vkId) {
      errorText.textContent = "Введите VK ID";
      return;
    }

    if (!/^[0-9a-zA-Z_]+$/.test(vkId)) {
      errorText.textContent = "Некорректный VK ID";
      return;
    }

    errorText.textContent = "";
    popup.style.display = "none";

    await submitApplication();
  };

  document.querySelector(".submit-btn").addEventListener("click", () => {
    if (validateForm()) {
      document.getElementById("popup").style.display = "flex";
    }
  });

  document.getElementById("popup").addEventListener("click", (e) => {
    if (e.target.id === "popup") {
      e.target.style.display = "none";
      document.getElementById("vk-id-input").value = "";
      document.getElementById("vk-error").textContent = "";
    }
  });

  const SIGHTENGINE_USER = '1630912505';
const SIGHTENGINE_SECRET = 'Kw4DsCevjJnKBvQLSHwNejUCjiyYfrBt';

async function checkTextWithSightengine(text) {
  const url = `https://api.sightengine.com/1.0/text/check.json?text=${encodeURIComponent(text)}&lang=ru&mode=standard&api_user=${SIGHTENGINE_USER}&api_secret=${SIGHTENGINE_SECRET}`;

  const res = await fetch(url);
  const json = await res.json();
  return json.profanity.matches.length === 0;
}

async function checkImageWithSightengine(imageUrl) {
  const url = `https://api.sightengine.com/1.0/check.json?url=${encodeURIComponent(imageUrl)}&models=nudity-2.0,wad,offensive,text-content&api_user=${SIGHTENGINE_USER}&api_secret=${SIGHTENGINE_SECRET}`;

  const res = await fetch(url);
  const json = await res.json();

  // Проверяем наличие полей в ответе
  if (!json || json.status === 'failure') {
    console.error('Sightengine error:', json.error || json);
    return false;
  }

  // Безопасно проверяем nudity (новый формат API)
  const isSafe = (
    (!json.nudity || json.nudity.safe >= 0.85) &&
    (!json.weapon || json.weapon < 0.1) &&
    (!json.drugs || json.drugs < 0.1) &&
    (!json.offensive || json.offensive.prob < 0.1)
  );

  return isSafe;
}
</script>
<script src="js/index.js"></script>


</body>
</html>